name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, production ]
  pull_request:
    branches: [ main, master, production ]

# Allow only one concurrent deployment per branch
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

# Note: DOCKER_IMAGE_NAME is set in each job that needs it

jobs:
  # Job 1: Build Application with Caching
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Create build artifacts
        run: |
          mkdir -p build
          cp -r frontend build/
          cp app.py build/
          cp requirements.txt build/
          echo "Build completed at $(date)" > build/build-info.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: build/
          retention-days: 7

  # Job 2: GitHub Pages Deployment
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify docs directory
        run: |
          echo "Checking docs directory contents:"
          ls -la docs/
          echo ""
          echo "Contents of docs/index.html (first 10 lines):"
          head -n 10 docs/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment complete
        run: |
          echo "## GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Visit your site at: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: Deploy to Development Environment (Docker Hub - dev tag)
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    environment:
      name: Development
      url: https://hub.docker.com

    env:
      DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/todo-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image (dev)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:dev
            ${{ env.DOCKER_IMAGE_NAME }}:dev-${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            environment=development
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max

      - name: Deployment summary
        run: |
          echo "## Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ env.DOCKER_IMAGE_NAME }}:dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View on [Docker Hub](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/todo-app/tags)" >> $GITHUB_STEP_SUMMARY

  # Job 4: Deploy to Production Environment (Docker Hub - prod tag)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/production'

    environment:
      name: Production
      url: https://hub.docker.com

    env:
      DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/todo-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image (prod)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:prod
            ${{ env.DOCKER_IMAGE_NAME }}:prod-${{ github.sha }}
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            environment=production
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max

      - name: Deployment summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ env.DOCKER_IMAGE_NAME }}:prod" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View on [Docker Hub](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/todo-app/tags)" >> $GITHUB_STEP_SUMMARY

  # Job 5: Deploy to Render (Optional - keeping for backward compatibility)
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [build, deploy-development]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    env:
      DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/todo-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "Warning: RENDER_DEPLOY_HOOK_URL not set"
            echo "Skipping deployment. Please set up Render Deploy Hook in GitHub Secrets."
            echo ""
            echo "To get your Deploy Hook URL:"
            echo "1. Go to your Render service dashboard"
            echo "2. Click 'Settings' tab"
            echo "3. Scroll to 'Deploy Hook'"
            echo "4. Copy the URL and add it as RENDER_DEPLOY_HOOK_URL secret in GitHub"
            exit 0
          fi

          echo "Triggering Render deployment via Deploy Hook..."
          response=$(curl -X POST "$RENDER_DEPLOY_HOOK_URL" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}" \
            -s)

          echo "Deployment response: $response"

          # Check if deployment was successful (HTTP 200 or 201)
          if echo "$response" | grep -q "HTTP Status: 20"; then
            echo "✅ Deployment triggered successfully!"
          else
            echo "⚠️  Deployment may have failed. Check Render dashboard."
            echo "Note: Render might still deploy successfully even with this warning."
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Deployed to Render" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ env.DOCKER_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check your Render dashboard for deployment status." >> $GITHUB_STEP_SUMMARY
